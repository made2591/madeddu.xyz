<!DOCTYPE html>
<html>
  <head>
    <!-- Google Tag Manager -->
    <!--<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M8WBXH7');</script>-->
    <!-- End Google Tag Manager -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href=/public/stylesheets/bs.css?random=@Environment.TickCount>
    <link rel="stylesheet" href=/public/stylesheets/styles.css?random=@Environment.TickCount>
    <link rel="stylesheet" href=/public/stylesheets/pygment_trac.css?random=@Environment.TickCount>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    <link rel="canonical" href="made2591.github.io/posts/compact-prediction-tree">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <link rel="icon" type="image/x-icon"  href="/favicon.ico" />
    <title>My first UniKernel image for sequence prediction | Matteo Madeddu</title>
    <!--[if lt IE 9]>

      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <!--<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M8WBXH7"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="wrapper">
        <section>
          <div id="header">
  <h1>
    <a id="sitename" href="">Matteo Madeddu</a>
  </h1>

  <!-- Add something about you in p tag-->
  <p>Mac OS lover, Docker fan, Go explorer, Python geek, Trello addicted.</p>
  <hr/>

  <span class="credits pull-left">
    
      <a href="/">Home</a>  | 
    
      <a href="/blog">Blog</a>  | 
    
      <a href="/archive">Archive</a>  | 
    
      <a href="/about">About</a>  | 
    
      <a href="/matteo_madeddu_cv.pdf">Resume</a>  | 
    
      <a href="/quotes">Quotes</a> 
    
  </span>

  <span class="credits pull-right social">
    
      
        <a href="https://github.com/made2591/" target="_blank"><i class="fa fa-github"></i></a>
      
    
      
        <a href="https://twitter.com/made2591" target="_blank"><i class="fa fa-twitter"></i></a>
      
    
      
        <a href="https://linkedin.com/in/mmadeddu" target="_blank"><i class="fa fa-linkedin"></i></a>
      
    
      
        <a href="https://www.facebook.com/matteo.madeddu" target="_blank"><i class="fa fa-facebook"></i></a>
      
    
  </span>


</div>


          <div class="post-title">
    <h1>My first UniKernel image for sequence prediction</h1>
    <p class="text-muted">
    


    30 Nov 2018
    
     | <i class="fa fa-comment"></i> <a class="text-muted" href="/posts/compact-prediction-tree/#disqus_thread"></a>
    

    
      | <i class="fa fa-tag"></i>
      
        <a class="text-muted" href="/tags/#coding ">coding</a>,
      
        <a class="text-muted" href="/tags/#unik ">unik</a>,
      
        <a class="text-muted" href="/tags/#cpt ">cpt</a>,
      
        <a class="text-muted" href="/tags/#ml ">ml</a>,
      
        <a class="text-muted" href="/tags/#sequence ">sequence</a>,
      
        <a class="text-muted" href="/tags/#prediction ">prediction</a>
      
    
  </p>
</div>

  <h3 id="introduction">Introduction</h3>
<p>Predicting the next item of a sequence over a finite alphabet has important applications in many domains. Since I always wanted to implemented something like that, while I was looking for an interesting approach I found this interesting idea based on tree. And you don‚Äôt deal with trees since a lot, be prepared because as usual it seams simple, but it not. Moreover, since I like Golang and I always wanted to try <a href="https://github.com/solo-io/unik">UniK</a>, I decided to implement my version of the CPT using Golang and use this exercise as a source to build my first unikernel image.</p>

<p align="center">
    <img src="https://i.imgur.com/fBN2q8z.png" alt="golang" style="width: 28%; marker-top: -10px;" />
    <img src="https://i.imgur.com/c7wzYDI.png" alt="sequenceprediction" style="width: 25%; marker-top: -10px; margin-left:15px" />
    <img src="https://i.imgur.com/suaVhnM.png" alt="unik" style="width: 20%; marker-top: -10px;" />
</p>

<p>The entire code is available in the Github repo <a href="https://github.com/made2591/go-cpt">here</a>.</p>

<h4 id="too-much-all-together">Too much all together</h4>
<p>I knew just a little bit of Golang, almost anything about the algorithm and nothing at all about unik. Let‚Äôs start from the algorithm.</p>

<h4 id="compact-prediction-tree">Compact Prediction Tree</h4>
<p>A <strong>CPT</strong> (<em>C</em>ompact <em>P</em>rediction <em>T</em>ree) losslessly compress the training data so that all relevant information is available for each prediction. Nice. The approach originally proposed<sup id="fnref:op"><a href="#fn:op" class="footnote">1</a></sup> by the T. Gueniche and P. F. Viger is incremental, offers a low time complexity for its training phase and it is easily adaptable for different applications and contexts. The performance of <strong>CPT</strong> with state of the art techniques, namely PPM (<em>P</em>rediction by <em>P</em>artial <em>M</em>atching), DG (<em>D</em>ependency <em>G</em>raph) and *all-K-th-order Markov chain. The results show that <strong>CPT</strong> yield higher accuracy on most datasets (up to 12% more than the second best approach), has better training time than DG and PPM, and is considerably smaller than all-K-th-Order Markov.</p>

<h4 id="the-structure">The structure</h4>
<p>The entire code is based on two foundamental structure: a trie<sup id="fnref:trie"><a href="#fn:trie" class="footnote">2</a></sup> or <code class="highlighter-rouge">PredictionTree</code> (<a href="https://github.com/made2591/go-cpt/blob/master/model/predictionTree/PredictionTree.go">code</a> of the package) and n <code class="highlighter-rouge">InvertedIndexTable</code> (<a href="https://github.com/made2591/go-cpt/blob/master/model/invertedIndexTable/InvertedIndexTable.go">code</a>).</p>

<h4 id="prediction-tree">Prediction Tree</h4>
<p>A Prediction Tree is a struct composed by 3 element:</p>
<ul>
  <li>Item ‚Äì the actual item stored in the tree, that in our case represent a 32bit int;</li>
  <li>Children ‚Äì the children of the tree, a slice of <code class="highlighter-rouge">PredictionTree</code> (see the code);</li>
  <li>Parent ‚Äì A reference to the Parent tree of the tree</li>
</ul>

<p>This is the reason a Prediction Tree is basically a trie data structure which compresses the entire training data into the form of a tree. Let‚Äôs say you have 4 difference sequence that contains a set of symbol predefined, like the one below:</p>

<ul>
  <li>[A, C, F, E]</li>
  <li>[A, C, B]</li>
  <li>[F, D, A]</li>
  <li>[F, E, D]</li>
</ul>

<p>Then, the respective Prediction Tree will be like the one below:</p>

<p align="center"><img src="https://i.imgur.com/N8FKLFq.png" alt="perceptron" style="width: 30%; marker-top: -10px;" /></p>

<h4 id="inverted-index-table">Inverted Index Table</h4>
<p>The Inverted Index Table maintain a reference for each symbol to respective sequences it belongs to. Let‚Äôs say you have 4 difference sequence that contains a set of symbol predefined, like the one below:</p>

<ul>
  <li>[A, C, F, E]</li>
  <li>[A, C, B]</li>
  <li>[F, D, A]</li>
  <li>[F, E, D, C]</li>
</ul>

<p>Then, the respective Inverted Index Table will be like the one below:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">¬†</th>
      <th style="text-align: center">seq_1</th>
      <th style="text-align: center">seq_2</th>
      <th style="text-align: center">seq_3</th>
      <th style="text-align: center">seq_4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">D</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">E</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">F</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
    </tr>
  </tbody>
</table>

<p>In the code a list of sequence references is maintained instead of a table.</p>

<p>####¬†Training (build the structs)
The training step consists in fullfill the structs by scanning a list of training sequences (list of list of symbols).</p>

<h4 id="testing-prediction">Testing (prediction)</h4>
<p>The prediction step involves making predictions for each testing sequence in an iterative manner. For a single row, the sequences similar to that row are found thanks to the Inverted Index Table. The consequent of the similar sequences are isolated and maintained in a dictionary with their scores. In the end, this dictionary is used to return the item with the highest score as the final prediction.</p>

<ul>
  <li>
    <p>The first step consists in finding the sequences <em>similar</em> to the target sequence [A,C]. These similar sequences are identified by finding the unique items in the target sequence, finding the set of sequence IDs in which a particular unique item is present and then, taking an intersection of the sets of all unique items. So the sequences in which A is present are the 1 and 2. C also is present in 1, 2 and 4. So the sequences somehow similar to [A,C] - our target sequence - is the intersection of set [1,2] and [1,2,4], thus [1,2] - or [A, C, F, E] and [A, C, B];</p>
  </li>
  <li>
    <p>The second step consists in finding the <em>consequent</em> of each similar sequence to the target sequence - still [A,C]. For each similar sequence, consequent is defined as the sub-sequence after the last occurrence of the last item of the target sequence in the similar sequence, without the items present in the target sequence. As we said the similar sequences are [1,2] - [A, C, F, E] and [A, C, B].</p>
  </li>
</ul>

<p>[A, C, F, E]: the subsequence after last occurence of C is [F, E]. Both of them are not present in [A,C], thus the consequent of this similar sequence is [F, E]. If you encountered in this set element part of the original target sequence, remove them;
[A, C, B]: the subsequence after last occurence of C is [B]. Again, B is not present in [A,C], thus the consequent of this similar sequence is [B];</p>

<ul>
  <li>The third step consists in adding scoring all the consequents of all the similar sequences for the target sequence in a dictionary along with their score. Let be the dictionary empty at the beginning - the score for the items in the Consequent [F, E] is calculated by following this rule: if the item is not present in the dictionary, then the score = 1 + (1 / number of similar sequences) + (1 / number of items currently in the countable dictionary + 1) * 0.001. Otherwise, score = the same multiplied by the oldscore.</li>
</ul>

<p>So for element E, i.e. the first item in the consequent of the first similar sentence, the score will be
score[F] = 1 + (1/3) + 1/(0+1) * 0.001 = 1.3343
score[E] = 1 + (1/3) + 1/(1+1) * 0.001 = 1.3338
score[B] = 1 + (1/3) + 1/(2+1) * 0.001 = 1.3336</p>

<p>Finally, [A,C] the key is returned with the greatest value in the dictionary of scores as the prediction. In the case of the above example, F is returned as a sequence prediction.</p>

<h3 id="unikimage">UniKImage</h3>

<blockquote>
  <p>True, linux is monolithic, and I agree that microkernels are nicer‚Ä¶ As has been noted (not only by me), the linux kernel is a minuscule part of a complete system: Full sources for linux currently runs to about 200kB compressed. And all of that source is portable, except for this tiny kernel that you can (probably: I did it) re-write totally from scratch in less than a year without having /any/ prior knowledge.</p>

  <p>Linus Torvalds, 1992</p>
</blockquote>

<p><a href="https://github.com/solo-io/unik">UniK</a> is a tool for compiling application sources into unikernels (lightweight bootable disk images) and MicroVM rather than binaries. UniK runs and manages instances of compiled images across a variety of cloud providers as well as locally: you can utilize it with a simple docker-like command line interface, that let you make and build unikernels and MicroVM as easy as building containers. UniK is built to be easily extensible, allowing (and encouraging) adding support for unikernel/MicroVM compilers and cloud providers. <a href="https://github.com/solo-io/unik/blob/master/docs/architecture.md">here</a> more details about the architecture.</p>

<h4 id="steps-to-build-image">Steps to build image</h4>
<p>To have the sequence prediction engine available as a bootable image, I used as said in the beginning. You can have a look at the repository on how to install everything is required. In the next paragraph I will provide someinsight you can find the original repository.</p>

<h5 id="install-and-configure-unik">Install and configure UniK</h5>
<p>Install unik by following instruction in official repository from <a href="https://github.com/solo-io/unik/blob/master/docs/install.md">here</a>.</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">git clone https://github.com/solo-io/unik.git
<span class="nb">cd </span>unik
make</code></pre></figure>

<p>then follow configuration step <a href="https://github.com/solo-io/unik/blob/master/docs/configure.md">here</a>.</p>

<h5 id="golang-server">Golang server</h5>
<p>Again, taken from unik repository. You have to ensure the project is cloned in $GOPATH, then:</p>

<ul>
  <li>Go installed and your $GOPATH configured (see getting started with Go)</li>
  <li>Your project should be located within your system‚Äôs $GOPATH (if you‚Äôre unfamiliar with Go and the $GOPATH convention, read more here)</li>
  <li>There should be a main package in the root directory of your project</li>
  <li>Godeps installed (run go get github.com/tools/godep once Go is installed)</li>
  <li>Run GO15VENDOREXPERIMENT=1 godep save ./‚Ä¶ from the root of your project.</li>
</ul>

<p>This will create a Godeps/Godeps.json file as well as place all dependencies of your project in the ./vendor directory. This will allow UniK to compile your application entirely using only the root directory of your project.</p>

<p>Open a shell and run the daemon - then keep it running:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">unik daemon <span class="nt">--debug</span></code></pre></figure>

<p>To build and run the image - remember to use godep to let unik include dependencies first!! - run:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">unik build <span class="nt">--name</span> go-cpt-image <span class="nt">--path</span> ./ <span class="nt">--base</span> rump <span class="nt">--language</span> go <span class="nt">--provider</span> virtualbox <span class="nt">--force</span>
unik run <span class="nt">--instanceName</span> go-cpt-instance <span class="nt">--imageName</span> go-cpt-image</code></pre></figure>

<p>To retrieve the running instances:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">unik instances</code></pre></figure>

<p>You should get something like this:</p>
<p align="center"><img src="https://github.com/made2591/go-cpt/blob/master/unik.png?raw=true" alt="golang" style="width: 100%; marker-top: -10px;" /></p>

<p>You can see IP assigned to instances in the last column of the output. To see the logs of the running instances run:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">unik logs <span class="nt">--instance</span> go-cpt-instance</code></pre></figure>

<p>What this image does is actually expose the different endpoint to initialize training and make prediction by rest api - <code class="highlighter-rouge">it's only a draft</code>:</p>

<p>A sample file are already uploaded into the upload folder: you can modify the <code class="highlighter-rouge">main.go</code> root of the project to avoid cutting the training and testing set. Otherwise, to see the run you can both execute the code locally or</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">curl http://&lt;YOUR_RUNNING_INSTANCES&gt;:8080/initcpt</code></pre></figure>

<p>You should see predictions for the first 10 sequences :-)</p>
<p align="center"><img src="https://github.com/made2591/go-cpt/blob/master/predictions.png?raw=true" alt="golang" style="width: 100%; marker-top: -10px;" /></p>

<h4 id="conclusion">Conclusion</h4>
<p>Many thanks to <a href="https://github.com/solo-io/unik/graphs/contributors">UniK contributors</a> for sure, to <a href="https://github.com/NeerajSarwan">NeerajSarwan</a> for his work over CPT and all who want to contribute</p>

<p>Thank you everybody for reading!</p>

<div class="footnotes">
  <ol>
    <li id="fn:op">
      <p>The original paper is available at <a href="https://www.researchgate.net/publication/263696690_Compact_Prediction_Tree_A_Lossless_Model_for_Accurate_Sequence_Prediction">here</a>.&nbsp;<a href="#fnref:op" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:trie">
      <p><a href="https://en.wikipedia.org/wiki/Trie">Trie</a> (Wikipedia).&nbsp;<a href="#fnref:trie" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>


<div class="comments">
   <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'made2591';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

</div>

<hr/>


  
    <div class="post-navs row">
      
        <div class="col-md-6 post-nav">

          <h3 class="section-header">
            Older
            <span class="text-muted"> &middot; </span>
            <a href="/archive">View Archive (35)</a>
          </h3>

          <h2 class="post-title-link"><a href="/posts/app-migrations">Migrations in modern companies: how to expect the unexpected from a real-life point of view</a></h2>
          <h3 id="prelude">Prelude</h3>
<p><code class="highlighter-rouge">Disclaimer</code> this post contains references to real problems, addressed in a disuruptive and totally not informed way. Lot of employees were mistreated to have enough material to write this post. What you will read is played by professionals: dont‚Äôt try this in your Company.</p>


        </div>
      
      

        <div class="col-md-6 post-nav">
          <h3 class="section-header">
            Newer
            
          </h3>

          <h2 class="post-title-link"><a href="/posts/machine-learning">Machine Learning is useless</a></h2>
          <h3 id="preamble">Preamble</h3>
<p>I would like to say ‚Äúrecently‚Äù, but actually is almost a few years I heard - and I‚Äôm still hearing a lot about Machine Learning and I didn‚Äôt want to believe it until now - believe me, I truly didn‚Äôt want to believe it - but yes here we are Machine Learning ufficially replace Big Data as buzzy word of the this past years, most problably will be still the word of the next year and I could not be more sad, frustrated, and worried about. Please haters don‚Äôt hate me, Internet don‚Äôt misunderstand me, companies don‚Äôt hire me, but first of all - please - don‚Äôt teach anything to your machines before finishing this post (!) ü§ì because they never learnt anything until now and they always felt good about so please - keep them simple operating system as they are, or at least talk with them before enrolled them in any advanced analytics course.</p>


        </div>
      
    </div>
  



          <div id="footer">
<hr/>
  <div class="pull-left">
    &copy;2019.
    Built with <a href="http://jekyllrb.com/">Jekyll</a> and
    <a href="https://github.com/kirqe/autm-rb">Autm-rb</a>. Thanks to <a href="https://github.com/kirqe">kirqe</a>.
  </div>

  <div class="pull-right">
    <span class="credits pull-right social">
      
        
          <a href="https://github.com/made2591/" target="_blank"><i class="fa fa-github"></i></a>
        
      
        
          <a href="https://twitter.com/made2591" target="_blank"><i class="fa fa-twitter"></i></a>
        
      
        
          <a href="https://linkedin.com/in/mmadeddu" target="_blank"><i class="fa fa-linkedin"></i></a>
        
      
        
          <a href="https://www.facebook.com/matteo.madeddu" target="_blank"><i class="fa fa-facebook"></i></a>
        
      
    </span>
  </div>
</div>

        </section>
    </div>
    </div>
    <script src="/public/javascripts/jquery.min.js"></script>
    <script src="/public/javascripts/bootstrap.min.js"></script>
    <!-- Place your <script> tags here. -->

<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

<script id="dsq-count-scr" src="//made2591-github-io.disqus.com/count.js" async></script>

<!-- disqus comment counter -->
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'made2591-github-io';

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function () {
	    var s = document.createElement('script'); s.async = true;
	    s.type = 'text/javascript';
	    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
	    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
	}());
</script>
<!-- /disqus comment counter -->

<!-- google analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111283556-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111283556-1');
</script>
<!-- /google analytics -->

  </body>
</html>
